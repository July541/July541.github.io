<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

      <title>1.2. 拖慢程序运行速度的原因</title>
    
          <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/theme.css " type="text/css" />
          <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/css/s4defs-roles.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/css/iframe.css" type="text/css" />
      
      <!-- sphinx script_files -->
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="../../../_static/theme-vendors.js"></script> -->
      <script src="../../../_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="../../../genindex.html" />
  <link rel="search" title="Search" href="../../../search.html" />
  <link rel="next" title="Glossary" href="../../glossary.html" />
  <link rel="prev" title="1.1. 如何使用本书" href="how_to_use.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../../../contents.html" class="home-link">
    
      <span class="site-name">Haskell Optimization Handbook</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">

  
    <div class="nav-item">
      <a href="../../../contents.html#haskell-optimization-handbook"
         class="nav-link ">
         Table of Contents
      </a>
    </div>
  
    <div class="nav-item">
      <a href="index.html#id1"
         class="nav-link  router-link-active">
         前期准备
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../../contents.html#indices-and-tables"
         class="nav-link ">
         indices and tables
      </a>
    </div>
  



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            

  
    <div class="nav-item">
      <a href="../../../contents.html#haskell-optimization-handbook"
         class="nav-link ">
         Table of Contents
      </a>
    </div>
  
    <div class="nav-item">
      <a href="index.html#id1"
         class="nav-link  router-link-active">
         前期准备
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../../contents.html#indices-and-tables"
         class="nav-link ">
         indices and tables
      </a>
    </div>
  



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="../../../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../../contents.html#haskell-optimization-handbook">Table of Contents</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../Preliminaries/index.html" class="reference internal ">Preliminaries</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../Measurement_Observation/index.html" class="reference internal ">Measurement, Profiling, and Observation</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../Optimizations/index.html" class="reference internal ">Optimizations</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../Case_Studies/index.html" class="reference internal ">Case Studies</a>
            

            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="index.html#id1">前期准备</a></span>
      </p>
      <ul class="current">
        
          <li class="toctree-l1 ">
            
              <a href="how_to_use.html" class="reference internal ">如何使用本书</a>
            

            
          </li>

        
          <li class="toctree-l1 current">
            
              <a href="#" class="reference internal current">拖慢程序运行速度的原因</a>
            

            
              <ul>
                
                  <li class="toctree-l2"><a href="#canonical-inlining" class="reference internal">内联</a></li>
                
                  <li class="toctree-l2"><a href="#canonical-fusion" class="reference internal">融合</a></li>
                
                  <li class="toctree-l2"><a href="#references" class="reference internal">References</a></li>
                
              </ul>
            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../../contents.html#indices-and-tables">indices and tables</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../glossary.html" class="reference internal ">Glossary</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../../../contents.html">Docs</a> &raquo;</li>
    
      <li><a href="index.html"><span class="section-number">1. </span>前期准备</a> &raquo;</li>
    
    <li><span class="section-number">1.2. </span>拖慢程序运行速度的原因</li>
  </ul>
  

  <ul class="page-nav">
  <li class="prev">
    <a href="how_to_use.html"
       title="previous chapter">← <span class="section-number">1.1. </span>如何使用本书</a>
  </li>
  <li class="next">
    <a href="../../glossary.html"
       title="next chapter">Glossary →</a>
  </li>
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <section id="sec-lethargy">
<span id="id1"></span><h1><span class="section-number">1.2. </span>拖慢程序运行速度的原因<a class="headerlink" href="#sec-lethargy" title="Permalink to this heading">¶</a></h1>
<p>本章会展示一些特定条件下导致 Haskell 代码运行变慢的程序，这些程序具有很典型的特征，因此也被称为样板(canonical)程序。在阅读本章后，读者应该对 Haskell 程序运行变慢的原因有基本的了解。本章提到的这些程序只是一个简单的介绍，对于具体的细节将会在书中的后续部分进行详细解释。</p>
<section id="canonical-inlining">
<span id="id2"></span><h2><span class="section-number">1.2.1. </span>内联<a class="headerlink" href="#canonical-inlining" title="Permalink to this heading">¶</a></h2>
<section id="id3">
<h3><span class="section-number">1.2.1.1. </span>什么是内联<a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
<p>内联 <a class="footnote-reference brackets" href="#id12" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> 是一个几乎所有编译器都会使用的简单的优化技巧。内联核心的想法是将函数 <code class="docutils literal notranslate"><span class="pre">f</span></code> 的调用点展开为 <code class="docutils literal notranslate"><span class="pre">f</span></code> 本身的实现。例如：</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">未执行内联</span><a class="headerlink" href="#id15" title="Permalink to this code">¶</a></div>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="c1">--- somewhere else</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>上述代码首先定义了一个函数 <code class="docutils literal notranslate"><span class="pre">f</span></code>，随后函数 <code class="docutils literal notranslate"><span class="pre">f</span></code> 应用于 <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">(a</span> <span class="pre">+</span> <span class="pre">b)</span> <span class="pre">-</span> <span class="pre">c</span></code>。内联机制会将 <code class="docutils literal notranslate"><span class="pre">f</span></code> 在调用点进行展开，<code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">(a</span> <span class="pre">+</span> <span class="pre">b)</span></code> 会被替换为 <code class="docutils literal notranslate"><span class="pre">f</span></code> 本身的实现。</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">执行内联</span><a class="headerlink" href="#id16" title="Permalink to this code">¶</a></div>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="c1">-- somewhere else</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>可以看到 <code class="docutils literal notranslate"><span class="pre">f</span></code> 的调用被替换为 <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">*</span> <span class="pre">3</span></code>，其中 <span class="math notranslate nohighlight">\(x \mapsto (a + b)\)</span>。</p>
</section>
<section id="id5">
<h3><span class="section-number">1.2.1.2. </span>为什么要进行内联<a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h3>
<p>内联也被称为“所有优化的起点”。首先，内联减少了函数调用的开销，这对频繁调用的函数有很大益处。其次，通过将函数的调用点替换为函数本身的实现，编译器在后续可以对内联之后的结果做进一步的优化来生成运行速度更快的代码。这种性能上的优化与其说是计算机科学的应用，比如说是艺术的展现，任何微小的变化都可能会产生出意想不到的效果。</p>
</section>
<section id="id6">
<h3><span class="section-number">1.2.1.3. </span>什么场景下内联会降低运行速度<a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h3>
<p>内联操作本身并不会降低运行速度，而缺乏内联会影响后续可能的优化操作的执行，从而导致运行速度降低。然而，这并不意味着我们需要永远让 GHC 执行内联操作或手动强制内联，相反，我们有时可以通过禁止内联来实现性能优势。在后续的 <a class="reference internal" href="../../Optimizations/Code_Changes/inlining.html#inlining-chapter"><span class="std std-ref">内联</span></a> 一章中会对内联的性能效果做出分析，并展示 GHC 如何执行内联。</p>
</section>
</section>
<section id="canonical-fusion">
<span id="id7"></span><h2><span class="section-number">1.2.2. </span>融合<a class="headerlink" href="#canonical-fusion" title="Permalink to this heading">¶</a></h2>
<section id="id8">
<h3><span class="section-number">1.2.2.1. </span>什么是融合<a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h3>
<p>融合 <a class="footnote-reference brackets" href="#id13" id="id9" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> <a class="footnote-reference brackets" href="#id14" id="id10" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> (Fusion，也被称为 Deforestation，这里参考 Andy  Gill 论文中的例子，感谢 Andy Gill 的工作！) 是一种消除函数调用之间的中间状态和临时数据结构的优化技术。由于 Haskell 惯用的函数组合的写法，融合成为了一种关键的优化方法。例如：</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">all</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="p">(</span><span class="n">map</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">xs</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>函数 <code class="docutils literal notranslate"><span class="pre">all</span></code> 通过 <code class="docutils literal notranslate"><span class="pre">map</span></code> 函数将 <code class="docutils literal notranslate"><span class="pre">p</span></code> 应用于 <code class="docutils literal notranslate"><span class="pre">xs</span></code> 的每个元素，在这个过程中产生了一个 bool 类型的 list。产生的 list 只是短暂地存在于计算的过程中，随后被应用于 <code class="docutils literal notranslate"><span class="pre">and</span></code> 产生最后的 bool 类型的结果。不幸的是，使用这个临时的 list 是十分昂贵的，需要在堆上为 list 的每个元素都申请内存、分配一个 <code class="docutils literal notranslate"><span class="pre">Cons</span></code>，并用 thunk 填充，然后赋一个具体的值，随后被 <code class="docutils literal notranslate"><span class="pre">and</span></code> 访问，最后再释放。完整的流程需要需要额外的 CPU 周期和垃圾回收机制。</p>
<p>融合可以将 <code class="docutils literal notranslate"><span class="pre">all</span></code> 这类函数转化为不需要中间 list 的形式。</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">all&#39;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="n">xs</span><span class="w"></span>
<span class="w">  </span><span class="kr">where</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="kt">[]</span><span class="w">     </span><span class="ow">=</span><span class="w"> </span><span class="kt">True</span><span class="w"></span>
<span class="w">        </span><span class="n">h</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="n">xs</span><span class="w"></span>
</pre></div>
</div>
<p>这个版本的 <code class="docutils literal notranslate"><span class="pre">all</span></code> <em>不会</em> 产生任何的中间 list，在对 <code class="docutils literal notranslate"><span class="pre">xs</span></code> 的每一步计算都会产生一个 bool 值，这个值会被直接应用到 <code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span></code>，产生一个由 <code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span></code> 连接到函数调用链（事实上这个调用链就是 <code class="docutils literal notranslate"><span class="pre">and</span></code> 函数的实现方式）。因为这一版本的实现成功地消除了中间状态的 list，也就是 <code class="docutils literal notranslate"><span class="pre">and</span></code> 和 <code class="docutils literal notranslate"><span class="pre">map</span></code> <em>融合</em> 了。</p>
</section>
<section id="id11">
<h3><span class="section-number">1.2.2.2. </span>为什么需要融合<a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h3>
<p>正如 Andy Gill 所说：</p>
<blockquote>
<div><p>We want to eat our cake and have it too. That is, we would like to write
programs in the style of <code class="docutils literal notranslate"><span class="pre">all</span></code> but have the compiler automatically
transform this into the more efficient version <code class="docutils literal notranslate"><span class="pre">all'</span></code>.</p>
</div></blockquote>
<p>大致翻译如下：</p>
<blockquote>
<div><p>鱼与熊掌，不可兼得。我们既想编写 <code class="docutils literal notranslate"><span class="pre">all</span></code> 风格的代码，也希望编译器可以自动将我们的代码转化为更高效的 <code class="docutils literal notranslate"><span class="pre">all'</span></code> 形式。</p>
</div></blockquote>
</section>
</section>
<section id="references">
<h2><span class="section-number">1.2.3. </span>References<a class="headerlink" href="#references" title="Permalink to this heading">¶</a></h2>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id12" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">1</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://wiki.haskell.org/Inlining_and_Specialisation">https://wiki.haskell.org/Inlining_and_Specialisation</a></p>
</aside>
<aside class="footnote brackets" id="id13" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id9">2</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.sciencedirect.com/science/article/pii/030439759090147A?via%3Dihub">https://www.sciencedirect.com/science/article/pii/030439759090147A?via%3Dihub</a></p>
</aside>
<aside class="footnote brackets" id="id14" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id10">3</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/07/deforestation-short-cut.pdf">https://www.microsoft.com/en-us/research/wp-content/uploads/2016/07/deforestation-short-cut.pdf</a></p>
</aside>
</aside>
</section>
</section>


          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
  <li class="prev">
    <a href="how_to_use.html"
       title="previous chapter">← <span class="section-number">1.1. </span>如何使用本书</a>
  </li>
  <li class="next">
    <a href="../../glossary.html"
       title="next chapter">Glossary →</a>
  </li>
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2022-2023, Jeffrey Young (doyougnu).
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.1.1 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>